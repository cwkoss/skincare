<!DOCTYPE html>
<html>
<head>
    <title>Skincare Formulation</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
<style>
    .small-text {
        font-size: 0.8em; /* Example size, adjust as needed */
        color: #666; /* Example color, adjust as needed */
    }
    .warning-text {
            color: red;
    }
    .description-text {
        font-size: 0.75em; /* Smaller than the main text */
        color: #555; /* Slightly darker than your small-text color */
        padding-top: 0.5em;
        padding-bottom: 0.5em;
    }
</style>

</head>
<body>
    <h2>Skincare Formulation</h2>
    <label for="userName">Your Name:</label>
    <input type="text" id="userName" name="userName" required placeholder="Enter your name">
    <label for="productType">Select Product Type:</label>
    <select id="productType" onchange="updateGuidance()">
        <option value="">Choose...</option>
        <option value="lotion">Lotion</option>
        <option value="cream">Cream</option>
        <option value="butter">Butter</option>
    </select>

    <p id="guidance">Please select a product type to see the formulation guidance.</p>
    <table id="skincareTable" class="table">
        <thead>
            <tr>
                <th>Ingredient</th>
                <th>Parts</th>
                <th>Percentage</th>
                <th>Comedogenic</th>
    	    <th>Viscosity</th>
            </tr>
        </thead>
        <tbody>
            <!-- Dynamic rows will be added here in the <tbody> section -->
        </tbody>
    </table>
        <form id="skincareForm">
            <button type="button" onclick="addIngredient()">Add Ingredient</button>
            <button type="submit">Submit Formulation</button>
        </form>

    <p id="overallOilPercentage">Overall Oil Percentage: </p>
    <p id="overallAqueousPercentage">Overall Aqueous Percentage: </p>
    <p id="overallemulsifierParts">Overall Emulsifier Percentage: </p>


    <p id="overallComedogenicRating">Overall Comedogenic Rating: </p>
    <p class="small-text">
        The comedogenic rating indicates how likely an ingredient is to clog pores. A lower rating (closer to 0) suggests that the ingredient is less likely to clog pores, while a higher rating (closer to 5) suggests a higher likelihood. This rating is crucial for individuals with acne-prone skin.
    </p>
    <p id="overallViscosityRating">Overall Viscosity Rating: </p>
    <p class="small-text">
        The viscosity rating reflects the thickness or fluidity of the final product. Lower viscosity values indicate a more fluid, water-like consistency, while higher values indicate a thicker, more solid consistency like that of butters or waxes. This helps in understanding the texture and spreadability of the skincare product.
    </p>
    <p id="productConsistency">Product Consistency: </p>
    <p id="emulsionWarning" class="warning-text"></p>

<script type="module">
  // Import Firebase app and Firestore services
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";



  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyD-XWrjMOmhRPjjRz-MOA1ARZN_RVwTcbc",
    authDomain: "skincare-recipe-tool.firebaseapp.com",
    projectId: "skincare-recipe-tool",
    storageBucket: "skincare-recipe-tool.appspot.com",
    messagingSenderId: "1053752399193",
    appId: "1:1053752399193:web:caf58158f655ca8e0f2848"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function handleSubmit(e) {
      e.preventDefault();

      const userName = document.getElementById('userName').value;
      const productType = document.getElementById('productType').value;
      const formulationData = getFormulationData();

      try {
          const docRef = await addDoc(collection(db, "formulations"), {
              userName: userName,
              productType: productType,
              formulation: formulationData
          });
          console.log("Document written with ID: ", docRef.id);
          // Handle successful submission, e.g., show a message to the user
      } catch (e) {
          console.error("Error adding document: ", e);
          // Handle errors here, e.g., show error message to the user
      }
  }

  // Export the handleSubmit function to make it accessible from other scripts
  window.handleSubmit = handleSubmit;

  function getFormulationData() {
      // Collect and return formulation data from the table
      const rows = document.getElementById('skincareTable').querySelectorAll('tbody tr');
      return Array.from(rows).map(row => {
          const ingredientSelect = row.querySelector('select[name="ingredient"]');
          const partsInput = row.querySelector('input[name="parts"]');

          const ingredient = ingredientSelect.value;
          const parts = partsInput.value;

          return { ingredient, parts: parts ? parseInt(parts) : 0 };
      }).filter(item => item.ingredient && item.parts > 0); // Filter out rows with empty ingredient or parts
  }

</script>
<script>

  const ingredients = {
    "Coconut oil": { phase: "oil", comedogenic: 4, viscosity: 5, description: "Moisturizes skin and hair, rich in fatty acids and antioxidants." },
    "Argan oil": { phase: "oil", comedogenic: 0, viscosity: 3, description: "Enhances skin elasticity and hair shine, rich in vitamin E." },
    "Sunflower oil": { phase: "oil", comedogenic: 2, viscosity: 3, description: "Lightweight, non-comedogenic oil, suitable for sensitive skin." },
    "Distilled water": { phase: "aqueous", comedogenic: 0, viscosity: 1, description: "Hydrates and serves as a base for water-soluble ingredients." },
    "Salt water": { phase: "aqueous", comedogenic: 0, viscosity: 1.5, description: "Research is mixed. Some sources suggest that salt water might have beneficial effects on the skin, including potential antimicrobial properties and the ability to dry out pimples. Salt water could also irritate sensitive skin or exacerbate conditions like eczema or dermatitis. " },
    "Beeswax": { phase: "emulsifier", comedogenic: 2, viscosity: 10, description: "Natural stabilizer, thickens formulas and creates protective barrier on skin." },
    "Cocoa butter": { phase: "emulsifier", comedogenic: 4, viscosity: 8, description: "Nourishes skin, reduces scars, and offers a chocolaty aroma." },
    "Pecan oil": { phase: "oil", comedogenic: 2, viscosity: 4, description: "Rich in antioxidants, moisturizes skin, and promotes hair health." },
    "Green tea": { phase: "aqueous", comedogenic: 0, viscosity: 1, description: "Rich in antioxidants, reduces inflammation, and promotes skin healing." },
    "Pumpkin seed oil": { phase: "oil", comedogenic: 2, viscosity: 4, description: "Improves skin tone, fights acne, and soothes sensitive skin." },
    "Benne seed oil": { phase: "oil", comedogenic: 3, viscosity: 4, description: "Rich in linoleic acid, nourishes skin and strengthens hair." },
    "Okra seed oil": { phase: "oil", comedogenic: 2, viscosity: 3, description: "Promotes a healthy scalp and is rich in unsaturated fats. (comedogenic rating estimated)" },
    "Olive oil": { phase: "oil", comedogenic: 2, viscosity: 4, description: "Moisturizes skin, rich in vitamins, and promotes hair health." },
    "Aloe Vera Gel": { phase: "aqueous", comedogenic: 0, viscosity: 2, description: "Soothes skin irritations, hydrates, and has healing properties." },
    "Shea Butter": { phase: "emulsifier", comedogenic: 0, viscosity: 6, description: "Moisturizes deeply, reduces inflammation, and is rich in vitamins." },
    "Jojoba Oil": { phase: "oil", comedogenic: 2, viscosity: 2, description: "Mimics natural skin oils, balances skin's sebum production." },
    "Glycerin": { phase: "aqueous", comedogenic: 0, viscosity: 2, description: "A humectant that draws moisture into the skin, suitable for all skin types." },
    "Almond Oil": { phase: "oil", comedogenic: 2, viscosity: 3, description: "Gentle on skin, rich in vitamin E, and excellent for dry skin." }
  };

  let selectedIngredients = [];

  document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('productType').value = ''; // Reset the product type selection
      addIngredient();
      document.getElementById('skincareForm').addEventListener('change', updateTable);
      document.getElementById('skincareForm').addEventListener('submit', window.handleSubmit);
  });

  function addIngredient() {
      const tableBody = document.getElementById('skincareTable').querySelector('tbody');
      const newRow = document.createElement('tr');
      newRow.innerHTML = `
          <td>
              <select name="ingredient" onchange="updateSelectedIngredients(this)">
                  <option value="">Select an ingredient</option>
                  ${Object.keys(ingredients).filter(ingredient => !selectedIngredients.includes(ingredient))
                      .map(ingredient => `<option value="${ingredient}">${ingredient}</option>`).join('')}
              </select>
          </td>
          <td><input type="number" name="parts" min="1" placeholder="Parts" oninput="updateTable()"></td>
          <td></td><td></td><td></td>
      `;
      tableBody.appendChild(newRow);
      updateTable();
  }

  function getRecommendedProportions(productType) {
      switch (productType) {
          case 'lotion':
              return { minOil: 8, maxOil: 23, minAqueous: 70, maxAqueous: 80, minEmulsifier: 3, maxEmulsifier: 6 };
          case 'cream':
              return { minOil: 20, maxOil: 40, minAqueous: 60, maxAqueous: 70, minEmulsifier: 3, maxEmulsifier: 6 };
          case 'butter':
              return { minOil: 20, maxOil: 40, minAqueous: 0, maxAqueous: 0, minEmulsifier: 0, maxEmulsifier: 10 };
          default:
              return null;
      }
  }

  function updateGuidance() {
      const productType = document.getElementById('productType').value;
      let guidanceText = '';

      switch (productType) {
          case 'lotion':
              guidanceText = 'Lotion: 70-80% Water, 3-6% Emulsifier, 8-23% Oils and Butters';
              break;
          case 'cream':
              guidanceText = 'Cream: 60-70% Water, 3-6% Emulsifier, Balanced mix of Oils and Butters';
              break;
          case 'butter':
              guidanceText = 'Butter: No Water, Emulsifier optional, 60-80% butters and 20-40% oils.  This balance can be adjusted to achieve the desired consistency; more butter leads to a thicker product, while more oil makes it softer and easier to spread.';
              break;
          default:
              guidanceText = 'Please select a product type to see the formulation guidance.';
      }

      document.getElementById('guidance').innerText = guidanceText;
      document.getElementById('guidance').classList.remove('warning-text'); // Reset warning class
  }

  function updateSelectedIngredients(selectElement) {
      selectedIngredients = Array.from(document.querySelectorAll('#skincareForm select[name="ingredient"]'))
                                .map(select => select.value)
                                .filter(value => value);
  }

  function getProductConsistency(viscosityRating) {
      if (viscosityRating >= 1 && viscosityRating <= 2) {
          return "Liquid";
      } else if (viscosityRating <= 4) {
          return "Lotion";
      } else if (viscosityRating <= 6) {
          return "Cream";
      } else if (viscosityRating <= 8) {
          return "Butter";
      } else {
          return "Wax";
      }
  }

  function checkEmulsionStability() {
      let hasOil = false, hasWater = false, emulsifierParts = 0;
      const totalParts = Array.from(document.getElementById('skincareTable').querySelector('tbody').rows)
          .reduce((total, row) => {
              const select = row.querySelector('select[name="ingredient"]');
              const input = row.querySelector('input[name="parts"]');
              const ingredient = select.value;
              const parts = parseInt(input.value) || 0;

              if (ingredient && parts > 0) {
                  if (ingredients[ingredient].phase === 'oil') {
                      hasOil = true;
                  }
                  if (ingredients[ingredient].phase === 'aqueous') {
                      hasWater = true;
                  }
                  if (ingredients[ingredient].phase === 'emulsifier') {
                      emulsifierParts += parts;
                  }
              }
              return total + parts;
          }, 0);

      const warningElement = document.getElementById('emulsionWarning');
      warningElement.innerText = '';

      // Add warning message if conditions are met
      if (hasOil && hasWater) {
          if (emulsifierParts < 3 * totalParts / 100) {
              warningElement.innerText = 'Warning: Your mixture contains both oil and water phases but does not have enough emulsifier. This may lead to separation.';
          } else if (emulsifierParts > 7 * totalParts / 100) {
              warningElement.innerText = 'Warning: Your mixture contains too much emulsifier, which may lead to skin irritation or a greasy feel.';
          }
      }
  }

  function updateTable() {
      const tableBody = document.getElementById('skincareTable').querySelector('tbody');
      let totalParts = 0;
      let totalComedogenic = 0;
      let totalViscosity = 0;

      // Sum up the total parts, comedogenic, and viscosity values
      Array.from(tableBody.rows).forEach(row => {
          const select = row.querySelector('select[name="ingredient"]');
          const input = row.querySelector('input[name="parts"]');

          const ingredient = select.value;
          const parts = parseInt(input.value) || 0;

          if (ingredient && parts > 0) {
              const comedogenic = ingredients[ingredient].comedogenic;
              const viscosity = ingredients[ingredient].viscosity;

              totalParts += parts;
              totalComedogenic += parts * comedogenic;
              totalViscosity += parts * viscosity;
          }
      });

      // Check for emulsion stability
      checkEmulsionStability();

      // Update the percentages, comedogenic, and viscosity for each ingredient
      Array.from(tableBody.rows).forEach(row => {
          const select = row.querySelector('select[name="ingredient"]');
          const input = row.querySelector('input[name="parts"]');
          const ingredient = select.value;
          const parts = parseInt(input.value) || 0;

          if (ingredient && parts > 0) {
              const percentage = ((parts / totalParts) * 100).toFixed(2);
              const comedogenic = ingredients[ingredient].comedogenic;
              const viscosity = ingredients[ingredient].viscosity;

              row.cells[2].innerText = `${percentage}%`;
              row.cells[3].innerText = comedogenic;
              row.cells[4].innerText = viscosity;
          }
      });

      const overallComedogenicRating = totalParts ? (totalComedogenic / totalParts).toFixed(2) : 0;
      const overallViscosityRating = totalParts ? (totalViscosity / totalParts).toFixed(2) : 0;
      const productConsistency = getProductConsistency(overallViscosityRating);

      document.getElementById('overallComedogenicRating').innerText = `Overall Comedogenic Rating: ${overallComedogenicRating}`;
      document.getElementById('overallViscosityRating').innerText = `Overall Viscosity Rating: ${overallViscosityRating}`;
      document.getElementById('productConsistency').innerText = `Product Consistency: ${productConsistency}`;

      calculateOverallPercentages(totalParts);
  }





  function calculateOverallPercentages(totalParts) {
      let totalOil = 0, totalAqueous = 0, totalEmulsifier = 0;
      const productType = document.getElementById('productType').value;
      const recommended = getRecommendedProportions(productType);
      const guidanceElement = document.getElementById('guidance');

      // Reset and update the guidance text based on the selected product type
      updateGuidance();

      Array.from(document.getElementById('skincareTable').querySelector('tbody').rows).forEach(row => {
          const select = row.querySelector('select[name="ingredient"]');
          const input = row.querySelector('input[name="parts"]');
          const ingredient = select.value;
          const parts = parseInt(input.value) || 0;

          if (ingredient && parts > 0) {
              switch (ingredients[ingredient].phase) {
                  case 'oil':
                      totalOil += parts;
                      break;
                  case 'aqueous':
                      totalAqueous += parts;
                      break;
                  case 'emulsifier':
                      totalEmulsifier += parts;
                      break;
              }
          }
      });

      if (totalParts > 0 && recommended) {
          const overallOilPercentage = ((totalOil / totalParts) * 100).toFixed(2);
          const overallAqueousPercentage = ((totalAqueous / totalParts) * 100).toFixed(2);
          const overallemulsifierParts = ((totalEmulsifier / totalParts) * 100).toFixed(2);

          document.getElementById('overallOilPercentage').innerText = `Overall Oil Percentage: ${overallOilPercentage}%`;
          document.getElementById('overallAqueousPercentage').innerText = `Overall Aqueous Percentage: ${overallAqueousPercentage}%`;
          document.getElementById('overallemulsifierParts').innerText = `Overall Emulsifier Percentage: ${overallemulsifierParts}%`;

          // Check if proportions are out of recommended ranges
          if (overallOilPercentage < recommended.minOil || overallOilPercentage > recommended.maxOil ||
              overallAqueousPercentage < recommended.minAqueous || overallAqueousPercentage > recommended.maxAqueous ||
              overallemulsifierParts < recommended.minEmulsifier || overallemulsifierParts > recommended.maxEmulsifier) {
              document.getElementById('guidance').classList.add('warning-text');
              document.getElementById('guidance').innerText += ' (Your current formulation is out of the recommended range for the selected product type.)';
          } else {
              document.getElementById('guidance').classList.remove('warning-text');
          }
      } else {
          document.getElementById('overallOilPercentage').innerText = `Overall Oil Percentage: 0%`;
          document.getElementById('overallAqueousPercentage').innerText = `Overall Aqueous Percentage: 0%`;
          document.getElementById('overallemulsifierParts').innerText = `Overall Emulsifier Percentage: 0%`;
      }
  }


</script>
</body>
</html>
